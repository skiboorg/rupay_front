<template>
  <page>
    <page-body class="q-px-md">
      <page-header>
      </page-header>

      <div class="" style="height: 60px"></div>
      <div v-if="action_type==='other' " class="q-mb-lg">
        <div v-if="asset.key!==1048610">
          <p class="q-mb-sm text-caption">–£–∫–∞–∂–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ—Ç–µ —Å–æ–≤–µ—Ä—à–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é*</p>
          <q-input class="q-mb-sm" rounded dense outlined  v-model="fromWallet"  />
          <div>
            <p class="q-mb-sm text-caption">–° —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤–∞–º–∏ –∫–æ—à–µ–ª—å–∫–∞ —Å–æ–≤–µ—Ä—à–∞–µ—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –∞–¥—Ä–µ—Å:</p>
            <p class="text-weight-medium q-mb-sm">{{asset.from_address}}</p>
            <q-btn rounded class="q-mb-sm" color="primary" label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å" @click="copyAddress" no-caps size="12px" unelevated  icon="las la-copy"/>
            <p class="q-mb-sm text-caption">
              –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –Ω–∞ –¥–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–ª—å–∫–æ <span class="text-weight-bold">{{asset.name}} {{asset.description}}</span><br>
              <span class="text-negative">–û—Ç–ø—Ä–∞–≤–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –º–æ–Ω–µ—Ç –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –∏—Ö –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–π –ø–æ—Ç–µ—Ä–µ</span><br>
              –°–æ–≤–µ—Ä—à–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ <span class="text-weight-bold">{{asset.name}}</span> –≤—ã –¥–µ–ª–∞–µ—Ç–µ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–∞–µ–≤–æ–π –≤–∑–Ω–æ—Å –ü–ö–†–ì–ò –†–û–õ–§
              –†–∞–≤–Ω—ã–π –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö {{asset.name}} –í—ã–≤–æ–¥ –º–æ–Ω–µ—Ç —Å –∫–æ—à–µ–ª—å–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –≤—ã–ø–ª–∞—Ç–æ–π –ø–æ –≤–∞—à–µ–º—É –≤–∑–Ω–æ—Å—É<br>
              –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å—Ä–æ–∫–∏ –¥–æ 24 —á–∞—Å–æ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—É–∫–∞–∑–∞–Ω—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏)
            </p>
            <p class="q-mb-sm text-caption">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è*</p>
            <q-input rounded class="q-mb-sm" dense outlined  v-model="amount" type="number" />
            <q-btn rounded color="primary" :loading="is_loading" @click="send" :disable="!amount || !fromWallet" unelevated no-caps class="full-width q-py-md" label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"/>
          </div>
        </div>
        <div v-else>
          <p class="q-mb-sm text-caption">C–æ–≤–µ—Ä—à–∞–µ—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –∞–¥—Ä–µ—Å:</p>
          <p class="text-weight-medium q-mb-sm">{{asset.from_address}}</p>
          <q-btn rounded class="q-mb-sm" color="primary" label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å" @click="copyAddress" no-caps size="12px" unelevated  icon="las la-copy"/>
          <p class="q-mb-sm text-caption">
            –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –Ω–∞ –¥–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–ª—å–∫–æ <span class="text-weight-bold">{{asset.name}} {{asset.description}}</span><br>
            <span class="text-negative">–û—Ç–ø—Ä–∞–≤–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –º–æ–Ω–µ—Ç –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –∏—Ö –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ–π –ø–æ—Ç–µ—Ä–µ</span><br>
          </p>
          <p class="q-mb-sm text-caption text-bold">–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ Transaction Hash, –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</p>

          <q-input rounded class="q-mb-sm" dense outlined  v-model="tx_hash"  />
          <q-btn rounded color="primary" :loading="is_loading" @click="checkTxHash" :disable="!tx_hash" unelevated no-caps
                 class="full-width q-py-md" label="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é"/>
        </div>

      </div>
      <div v-else class="q-mb-lg">
        <q-scroll-area style="height: 85vh;">
          <div v-if="selected_payment.value !== 'rs'">
            <q-select rounded v-if="asset.key === 2 || asset.key===1643 || asset.key===1048610" v-model="selected_payment" outlined dense :options="payment_systems" class="q-mb-md" label="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–ø–ª–∞—Ç—ã"/>

            <p class="q-mb-sm text-caption">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ {{selected_payment.currency}}*<br>
              <span class="text-bold text-negative ">
              –º–∏–Ω–∏–Ω—É–º {{selected_payment.min}} {{selected_payment.currency}},
              –º–∞–∫—Å–∏–º—É–º {{selected_payment.max}} {{selected_payment.currency}},
            –∫–æ–º–∏—Å—Å–∏—è {{selected_payment.commission * 100}} %</span></p>
            <q-input rounded class="q-mb-sm" dense outlined  v-model="to_pay" type="number" label="–ù–∞ –∫–∞–∫—É—é —Å—É–º–º—É —Ö–æ—Ç–∏—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å*"/>
            <p  class="q-mb-sm text-caption text-bold">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: {{want_to_buy}} {{asset.name}}</p>

            <q-btn color="primary" rounded :loading="is_loading" @click="new_payment" :disable="to_pay<selected_payment.min || to_pay>selected_payment.max" unelevated no-caps class="full-width q-py-md" label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"/>

          </div>
          <div v-else>

            <div v-if="!is_sent"><p class="q-mb-sm text-caption">–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ä—É–±–ª—è—Ö* (<span class="text-bold text-negative">–º–∏–Ω–∏–Ω—É–º 1000 —Ä—É–±</span>)</p>
              <q-input rounded class="q-mb-sm" dense outlined  v-model="amount" type="number" />
              <p class="q-mb-sm text-caption text-bold">–í—ã –ø–æ–ª—É—á–∏—Ç–µ: {{amount / asset.course}} {{asset.name}}</p>
              <q-btn color="primary"  :loading="is_loading" @click="send" :disable="!amount || amount<1000" unelevated no-caps class="full-width q-py-md q-mb-md" rounded label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å"/>
            </div>
            <div v-else> <p class="text-bold">–í–Ω–∏–º–∞–Ω–∏–µ!</p>
              <p class="q-mb-sm text-caption">–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ {{asset.name}} –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º –Ω–∏–∂–µ —Å–æ–≤–µ—Ä—à–∞–µ—Ç–µ –æ–ø–ª–∞—Ç—É –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∑–∞—Ç—å:</p>
              <p class="q-mb-sm text-caption text-weight-bold"> –î–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π —á–ª–µ–Ω—Å–∫–∏–π –≤–∑–Ω–æ—Å –æ—Ç –§–ò–û, –ö–û–î {{code}}</p>
              <p class="q-mb-sm text-caption text-weight-bold">  –í–ù–ò–ú–ê–ù–ò–ï –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –ü–õ–ê–¢–ï–ñ–ê –î–û–õ–ñ–ù–û –°–û–í–ü–ê–î–ê–¢–¨ –° –£–ö–ê–ó–ê–ù–ù–´–ú –í –ò–ù–°–¢–†–£–ö–¶–ò–ò.</p>
              <p class="q-mb-sm text-caption">   –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ {{asset.name}} –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–µ—á–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç!
                –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–æ–≤–µ—Ä—à–∞—Ç—å –æ–ø–ª–∞—Ç—É —Å –ê–ª—å—Ñ–∞ –ë–∞–Ω–∫–∞, —Ç–æ–≥–¥–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –±—ã—Å—Ç—Ä–µ–µ.
                –û–ø–ª–∞—Ç–∞ —Å –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤ –º–æ–∂–µ—Ç –∑–∞—Ç—è–Ω—É—Ç—å –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–æ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.</p>
              <div class="text-center">
                <img style="width: 300px;height: 300px;object-fit: contain" src="~assets/qr.jpg"/>
              </div>

              <p class="q-mb-lg text-caption"><span style="font-weight: bold">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤–∑–Ω–æ—Å–æ–≤</span><br>
                –ù–æ–º–µ—Ä —Å—á—ë—Ç–∞: 40703810326350000009<br>
                –í–∞–ª—é—Ç–∞: RUR<br>
                –ù–∞–∑–≤–∞–Ω–∏–µ: –ü–û–¢–†–ï–ë–ò–¢–ï–õ–¨–°–ö–ò–ô –ö–û–û–ü–ï–†–ê–¢–ò–í –ü–û –†–ê–ó–í–ò–¢–ò–Æ –ì–†–ê–ñ–î–ê–ù–°–ö–ò–• –ò–ù–ò–¶–ò–ê–¢–ò–í "–†–û–õ–§"<br>
                –ò–ù–ù: 2366034781<br>
                –ö–ü–ü: 236601001<br>
                –ë–∞–Ω–∫: –§–ò–õ–ò–ê–õ "–†–û–°–¢–û–í–°–ö–ò–ô" –ê–û "–ê–õ–¨–§–ê-–ë–ê–ù–ö"<br>
                –ë–ò–ö: 046015207<br>
                –ö–æ—Ä. —Å—á—ë—Ç: 30101810500000000207<br>
                –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å –∫–æ–º–ø–∞–Ω–∏–∏: —É–ª–∏—Ü–∞ –ì–û–†–¨–ö–û–ì–û, –¥. 60/4, –∫–≤./–æ—Ñ. 44, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, —Ä-–Ω –ì–û–†–û–î-–ö–£–†–û–†–¢ –°–û–ß–ò, –≥. –°–æ—á–∏</p></div>


          </div>

        </q-scroll-area>
      </div>
    </page-body>
  </page>

</template>
<script setup>

import { useEraStore } from 'stores/eraChain'
const sraStore = useEraStore()

import { useAccountStore } from 'stores/account'
const accountStore = useAccountStore()

import {computed, ref,onBeforeMount} from "vue";
import {api} from "boot/axios";
import axios from 'axios'

import {useRoute} from "vue-router"

const route = useRoute()

import {useNotify} from "src/helpers/utils";
import { copyToClipboard } from 'quasar'

const URL = 'https://rupay.pro'
//const URL = 'http://localhost:8010'

let action_type = ref(null)
let code = ref(null)
let amount = ref(null)
let fromWallet = ref(null)
let is_loading = ref(false)
let is_sent = ref(false)
let asset_key = ref(0)
let to_pay = ref(300)
let summ = ref(0)
let tx_hash = ref(null)
let comission = ref(0.02)
let current_course = ref(0)
const selected_payment = ref({label:'Visa/Mastercard',currency:"RUB",value:'Card1',min:300,max:50000,commission:0})

const payment_systems = [
  {label:'Visa/Mastercard',value:'Card1',currency:"RUB", min:300,max:50000,commission:0},
  {label:'Qiwi',value:'Qiwi',currency:"RUB",min:300,max:50000,commission:0},
  {label:'–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –†/–°',value:'rs',currency:"RUB",min:1000,max:50000,commission:0},
]

const want_to_buy = computed(()=>{


  if (asset.value.key === 2 || asset.value.key ===1048610){
    summ.value = to_pay.value
    return parseFloat(parseFloat(to_pay.value / asset.value.course) - parseFloat(to_pay.value / asset.value.course * selected_payment.value.commission)).toFixed(5)
  }else{
    summ.value = to_pay.value * asset.value.course_api
    return parseFloat(to_pay.value - (to_pay.value * selected_payment.value.commission)).toFixed(5)
  }

})

async function checkTxHash(){
  is_loading.value = !is_loading.value
  const response = await axios.post(URL+'/api/data/check_tx_hash',{
    tx:tx_hash.value,
    wallet:current_address.value,
    addr:asset.value.from_address
  })
  if (response.data.success){
    useNotify('positive',JSON.stringify(response.data.message))
  }else {
    useNotify('negative',JSON.stringify(response.data.message))
  }

  is_loading.value = !is_loading.value
}

async function new_payment(){
  is_loading.value = !is_loading.value
  const response = await axios.post(URL+'/api/data/create_payment',
    {
      wallet:current_address.value,
      type:selected_payment.value.value,
      want_to_buy:want_to_buy.value,
      amount:summ.value,
      currency : asset.value.key === 2 || asset.value.key === 1643 || asset.value.key === 1048610 ? selected_payment.value.currency : 'USD',
      asset_id:asset.value.key
    }
  )
  is_loading.value = !is_loading.value
  if (response.data.success){
    window.location.href = response.data.url
  }else {
    useNotify('negative',JSON.stringify(response.data.message))
  }

}

async function send(){
  is_loading.value = !is_loading.value
  await api.post('/api/settings/payment_request',{
    code:code.value,
    wallet:current_address.value,
    fromWallet:fromWallet.value,
    currency:asset.value.name,
    amount:amount.value,
  })
  let add_text = ''
  if (asset.value.key===1048610){
    add_text = 'üÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏èüÖ∞Ô∏è'
  }


  await axios.get(`https://api.telegram.org/bot603507616:AAEmmGeaujFe_lqkw31HHSoh2EiAvVNtFA4/sendMessage?chat_id=-542426502
  &text=${add_text}–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å RUPAY%0A
  –ö–æ–¥ : ${code.value}%0A
  –° –∫–æ—à–µ–ª–µ–∫–∞ ${fromWallet.value}%0A
  –ù–∞ –∫–æ—à–µ–ª–µ–∫ ${current_address.value}%0A
  –ê–∫—Ç–∏–≤ ${asset.value.name}%0A
  –°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${amount.value} ${asset.value.name}

`
  )
  code.value = makeid(4)
  fromWallet.value=null
  amount.value=null

  is_loading.value = !is_loading.value
  is_sent.value = true
  useNotify('positive','–ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω<br>–û–∂–∏–¥–∞–µ–º –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤')


}


function copyAddress(){
  copyToClipboard(asset.value.from_address)
    .then(() => {
      useNotify('positive', '–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω')
    })
    .catch(() => {
      // fail
    })
}

const asset = computed(()=>{
  return sraStore.assets.find(x=>x.key===asset_key.value)
})

const current_address = computed(()=>{
  return accountStore.addresses[accountStore.currentAddressIdx].address
})

function makeid(length) {
  var result           = '';
  var characters       = '0123456789';
  var charactersLength = characters.length;
  for ( var i = 0; i < length; i++ ) {
    result += characters.charAt(Math.floor(Math.random() *
      charactersLength));
  }
  return result;
}

onBeforeMount( async ()=>{
  asset_key.value = parseInt(route.query.asset)
  action_type.value = route.query.type
  code.value=makeid(4)
  if (asset.value.payment_system){
    selected_payment.value = {label:asset.value.payment_system,
      value:asset.value.payment_system,
      currency:`${asset.value.name}`,
      min:asset.value.payment_min / asset.value.course_api,
      max:asset.value.payment_max / asset.value.course_api,

      commission:asset.value.payment_comission/100
    }
    to_pay.value = asset.value.payment_min / asset.value.course_api
  }

})
</script>

<style lang="sass">
.qr-card
  max-width: 80%
  margin: 0 auto 16px

  &-text
    font-size: 12px
    text-align: center
    line-height: 120%
</style>
